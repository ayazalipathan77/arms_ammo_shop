# ğŸš€ Option 1: Single Service Deployment Guide

## Overview
Deploy both backend and frontend in a **single Web Service** on Render. The backend serves the frontend's static files in production.

---

## âœ… Files Updated & Ready

### 1. **render-build.sh** âœ…
- Installs backend dependencies with `NODE_ENV=development` (TypeScript types)
- Generates Prisma Client
- Syncs database schema with `prisma db push`
- Builds backend TypeScript â†’ `server/dist/`
- Installs frontend dependencies
- Builds frontend Vite app â†’ `dist/`

### 2. **server/src/app.ts** âœ…
- Serves static files from `dist/` in production
- Handles client-side routing (all routes â†’ index.html)
- API routes at `/api/*`

### 3. **server.js** âœ…
- Starts the compiled server from `server/dist/server.js`

---

## ğŸ¯ Render Configuration

### **Web Service Settings:**

| Setting | Value |
|---------|-------|
| **Service Type** | Web Service |
| **Name** | muraqqa-fullstack (or any name) |
| **Root Directory** | (empty - leave blank) |
| **Build Command** | `./render-build.sh` |
| **Start Command** | `node server.js` |
| **Node Version** | 20 (auto-detected from .node-version) |

---

## ğŸ”§ Environment Variables

Set these in Render Dashboard â†’ Service â†’ Environment:

```env
NODE_ENV=production
DATABASE_URL=<your-render-postgres-url>
JWT_SECRET=<auto-generated-or-manual>
JWT_EXPIRES_IN=7d
CLOUDINARY_CLOUD_NAME=didfxynsu
CLOUDINARY_API_KEY=898752622996387
CLOUDINARY_API_SECRET=<from-your-env>
CLIENT_URL=<your-render-service-url>
```

**Important:** Since frontend and backend are on the same domain, set `CLIENT_URL` to your service URL:
```
CLIENT_URL=https://muraqqa-fullstack.onrender.com
```

---

## ğŸ“¦ Deployment Steps

### 1. Commit Your Changes

```bash
# Stage all updated files
git add render-build.sh server/src/app.ts server/package.json

# Commit
git commit -m "feat: configure single-service deployment with render-build.sh"

# Push to GitHub
git push origin ver4
```

### 2. Update Render Service Settings

1. Go to your service in Render Dashboard
2. Click **"Settings"** tab
3. Update these fields:
   - **Root Directory**: Clear it (make it empty)
   - **Build Command**: `./render-build.sh`
   - **Start Command**: `node server.js`
4. Click **"Save Changes"**

### 3. Clear Build Cache & Deploy

1. In Settings, scroll to **"Deploy"** section
2. Click **"Clear build cache & deploy"**
3. Monitor build logs

---

## ğŸ“Š Expected Build Output

```bash
==> Cloning from GitHub
==> Using Node.js 20.20.0 from .node-version
==> Running build command './render-build.sh'

Build started...

Installing backend dependencies...
âœ“ NODE_ENV=development npm install
  added 242 packages (with devDependencies)

Generating Prisma Client...
âœ“ Prisma Client generated

Syncing database schema...
âœ“ Database synchronized

Building backend...
âœ“ TypeScript compiled to server/dist/

Installing frontend dependencies...
âœ“ npm install (frontend)

Building frontend...
âœ“ Vite built to dist/

Build complete!

==> Uploading build...
==> Build successful ğŸ‰

==> Deploying...
==> Running 'node server.js'

ğŸ›¡ï¸  Server listening on port: 10000 ğŸ›¡ï¸

==> Your service is live ğŸ‰
```

---

## ğŸŒ How It Works

### Architecture:

```
User Request
     â†“
Render Service (Port 10000)
     â†“
Express Server (server/dist/server.js)
     â”œâ”€â†’ /api/*          â†’ Backend API Routes
     â”œâ”€â†’ /health         â†’ Health Check
     â””â”€â†’ /* (others)     â†’ Serve frontend (dist/index.html)
```

### File Structure After Build:

```
/opt/render/project/
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ dist/           â† Compiled backend (TypeScript â†’ JS)
â”‚   â”‚   â””â”€â”€ server.js
â”‚   â”œâ”€â”€ src/            â† Backend source
â”‚   â”œâ”€â”€ prisma/
â”‚   â””â”€â”€ node_modules/
â”œâ”€â”€ dist/               â† Built frontend (Vite production build)
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ assets/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ server.js           â† Startup wrapper
â””â”€â”€ render-build.sh     â† Build script
```

---

## ğŸ§ª Testing Your Deployment

### 1. Frontend Test
Visit: `https://your-service-url.onrender.com`
- Should load the gallery homepage
- Artworks should display
- Navigation should work

### 2. API Test
```bash
curl https://your-service-url.onrender.com/api/artworks
```
Should return JSON array of artworks

### 3. Health Check
```bash
curl https://your-service-url.onrender.com/health
```
Should return: `{"status":"ok","timestamp":"..."}`

### 4. Authentication Test
- Go to your frontend
- Click Login
- Test credentials:
  - Admin: `admin@muraqqa.com` / `admin123`
  - Artist: `sadequain@muraqqa.com` / `artist123`
  - User: `user@example.com` / `user123`

---

## ğŸŒ± Post-Deployment: Seed Database

After successful deployment:

1. Go to Render Dashboard â†’ Service â†’ **"Shell"** tab
2. Run seeding commands:

```bash
# Seed main data
cd server && npm run seed

# Seed landing page
cd server && npm run seed:landing
```

Expected output:
```
ğŸŒ± Starting database seed...
âœ… Admin user created: admin@muraqqa.com
âœ… Artist created: Sadequain (Tribute)
âœ… Artist created: Ahmed Khan
âœ… Artist created: Alia Syed
âœ… Artwork created: Echoes of Lahore Fort
... (more artworks)
âœ… Sample user created: user@example.com
ğŸ‰ Database seeding completed!

âœ… Landing page content seeded successfully!
```

---

## ğŸ” Troubleshooting

### Issue: "Cannot find module" errors
**Cause:** Build didn't complete or files not uploaded
**Solution:**
1. Check build logs for errors
2. Ensure render-build.sh is executable: `chmod +x render-build.sh`
3. Clear build cache and redeploy

### Issue: 404 on frontend routes
**Cause:** Client-side routing not configured
**Solution:** Already fixed in app.ts - all non-API routes serve index.html

### Issue: API CORS errors
**Cause:** CLIENT_URL mismatch
**Solution:** Set `CLIENT_URL` to match your service URL exactly

### Issue: Database connection fails
**Cause:** DATABASE_URL incorrect or database not running
**Solution:**
1. Verify DATABASE_URL in environment variables
2. Ensure it ends with `?sslmode=require`
3. Check database status in Render dashboard

### Issue: Prisma schema not found during build
**Cause:** Working directory confusion
**Solution:** Already fixed - `prisma.schema` in package.json + script handles `cd server`

---

## ğŸ“ˆ Performance Considerations

### Pros:
âœ… Single service = simpler management
âœ… Lower cost (one service)
âœ… No CORS issues (same origin)
âœ… Shared session/cookies easier

### Cons:
âš ï¸ Frontend not on CDN (slower for static assets)
âš ï¸ Backend and frontend scale together (less flexible)
âš ï¸ Larger deployment bundle

### Optimization Tips:
- Enable Gzip compression (already in server via `compression` middleware)
- Use Cloudinary CDN for images (already configured)
- Consider upgrading to paid Render plan for better performance
- Monitor build times and optimize dependencies if needed

---

## ğŸ‰ Success Checklist

- [ ] All files committed and pushed to GitHub
- [ ] Render service Root Directory is empty
- [ ] Build Command set to `./render-build.sh`
- [ ] Start Command set to `node server.js`
- [ ] All environment variables configured
- [ ] Build completes successfully (no TypeScript/Prisma errors)
- [ ] Service starts and listens on port 10000
- [ ] Frontend loads at root URL
- [ ] API responds at `/api/*` routes
- [ ] Database seeded successfully
- [ ] Authentication works
- [ ] Cloudinary uploads work

---

## ğŸ”„ Updating Your Application

### For Code Changes:

1. Make changes locally
2. Test locally: `cd server && npm run dev` + `npm run dev` (frontend)
3. Commit and push: `git push origin ver4`
4. Render auto-deploys (or trigger manually)

### For Database Schema Changes:

1. Update `server/prisma/schema.prisma`
2. Test locally: `cd server && npx prisma db push`
3. Commit and push
4. Render build will auto-sync schema via `prisma db push`

---

## ğŸ“š Related Documentation

- [DEPLOYMENT_SUMMARY.md](DEPLOYMENT_SUMMARY.md) - Overall deployment overview
- [RENDER_ENV_VARIABLES.md](RENDER_ENV_VARIABLES.md) - Environment variables reference
- [RENDER_FINAL_CONFIG.md](RENDER_FINAL_CONFIG.md) - Complete configuration guide
- [render-deployment-guide.md](render-deployment-guide.md) - Detailed deployment guide

---

## ğŸ†˜ Need Help?

1. **Check Render Logs**: Build logs show compilation errors, Runtime logs show server errors
2. **Review Configuration**: Compare with this guide
3. **Clear Cache**: Settings â†’ Deploy â†’ Clear build cache & deploy
4. **Check Database**: Ensure PostgreSQL is running and accessible

---

**You're all set! ğŸš€**

Commit the changes, update Render settings, and deploy!

---

**Last Updated:** 2026-02-06
**Status:** Ready for deployment
**Option:** Single Service (Backend serves Frontend)
